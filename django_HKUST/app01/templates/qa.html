{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Q&A Dialog</title>
    <link rel="stylesheet" href="{% static 'css/for_qa.css' %}">
</head>
<body>
<div style="height: 100%; width: 100%;overflow: hidden">
    <div id="chat-container">
        <div id="chat-box">
            <div id="messages"></div>
        </div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Type your question here...">
            <button id="send-button">Send</button>
        </div>
    </div>
</div>


<script>
    // script.js
    document.getElementById('send-button').addEventListener('click', function () {
        const userInput = document.getElementById('user-input').value;
        if (userInput.trim() !== "") {
            addMessage(userInput, 'user');
            document.getElementById('user-input').value = '';

            generateBotResponse(userInput)

            // Simulate bot response
            {#setTimeout(function () {#}
            {#    const botResponse = generateBotResponse(userInput);#}
            {#    streamBotResponse(botResponse);#}
            //}, 500);

            // openAI回应
            {#$.ajax({#}
            {#    url: 'http://127.0.0.1:8000/qa/chat',#}
            {#    type: 'POST',#}
            {#    contentType: 'application/json', // 发送信息至服务器时内容编码类型#}
            {#    data: JSON.stringify({'message': userInput}),#}
            {#    success: function (res) {#}
            {#        let request = JSON.parse(res)#}
            {#        console.log(request)#}
            {#    }#}
            //})
        }
    });

    function addMessage(message, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender + '-message');
        messageElement.textContent = message;
        document.getElementById('messages').appendChild(messageElement);
        messageElement.scrollIntoView({behavior: 'smooth'});
    }

    function generateBotResponse(userInput) {
        // This is a placeholder response.
        // In a real application, you would replace this with an API call to your backend or AI model.
        let botRes
        let entityRes
        $.ajax({
            url: 'http://127.0.0.1:8000/qa/chat',
            type: 'POST',
            contentType: 'application/json', // 发送信息至服务器时内容编码类型
            data: JSON.stringify({'message': userInput}),
            success: function (res) {
                let request = JSON.parse(res)
                botRes = request['response']
                entityRes = request['entity']
                controlGraph(botRes, entityRes)
            }
        })
        return botRes;
    }
    function old_generateBotResponse(userInput) {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', 'http://127.0.0.1:8000/qa/chat', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
    
        let responseBuffer = ''; // 用于缓存所有数据块
        let completeMessage = ''; // 缓存完整消息
    
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 3) { // 处理流式数据
                responseBuffer += xhr.responseText;
    
                try {
                    // 检查是否接收到完整的消息块
                    let endIndex = responseBuffer.lastIndexOf('\n');
                    if (endIndex !== -1) {
                        let chunks = responseBuffer.slice(0, endIndex).split('\n');
                        responseBuffer = responseBuffer.slice(endIndex + 1); // 更新缓冲区
    
                        // 处理每个消息块
                        for (let chunk of chunks) {
                            try {
                                // 解析 JSON 数据
                                let json = JSON.parse(chunk);
                                if (json.response) {
                                    completeMessage += json.response;
                                }
                            } catch (e) {
                                console.error("解析数据块时出错:", e);
                            }
                        }
    
                        // 更新 UI 显示完整消息
                        if (completeMessage.trim()) {
                            streamBotResponse(completeMessage);
                            completeMessage = ''; // 清空缓存
                        }
                    }
                } catch (e) {
                    console.error("处理数据块时出错:", e);
                }
            }
        };
    
        xhr.send(JSON.stringify({'message': userInput}));
    }

    

    function controlGraph(botRes, entityRes) {
        console.log(entityRes)
        disableComponent()
        streamBotResponse(botRes)
        let clear = {
            'nodes': [],
            'links': [],
        }
        updateGraph(clear)
        InitGraphByQA(entityRes)
    }



    function streamBotResponse(message) {
        const messageContainer = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'bot-message');
        messageContainer.appendChild(messageElement);
        messageElement.scrollIntoView({behavior: 'smooth'});

        let index = 0;
        const interval = setInterval(() => {
            if (index < message.length) {
                messageElement.textContent += message[index];
                index++;
            } else {
                clearInterval(interval);
            }
            messageElement.scrollIntoView({behavior: 'smooth'});
        }, 5); // Adjust the interval time to control the speed of the typing effect
    }
    

    // Allow pressing Enter to send the message
    document.getElementById('user-input').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            document.getElementById('send-button').click();
        }
    });

</script>
</body>
</html>