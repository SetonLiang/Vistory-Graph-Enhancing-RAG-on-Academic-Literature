<!DOCTYPE html>
{% load static %}
{% load my_filter %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chart</title>
    <link rel="stylesheet" href="{% static 'css/for_chart.css' %}">
    <style>
    </style>
</head>
<body>

<!-- Create a div where the graph will take place -->
<div id="dataVis" class="chart_container">
    <div class="chart">
        <svg id="chart2"></svg>
    </div>
    <div class="chart">
        <svg id="chart3"></svg>
    </div>
    <div class="chart">
        <svg id="chart1"></svg>
    </div>
    <div class="chart">
        <svg id="chart4"></svg>
    </div>
</div>

<script>
    const containerWidth = d3.select('.chart_container').node().getBoundingClientRect().width;
    const containerHeight = d3.select('.chart_container').node().getBoundingClientRect().height;
    const chartWidth = containerWidth; // 每个图表宽度占容器的25%
    const chartHeight = containerHeight/4;
    const marginTop = 10;
    const marginRight = 10;
    const marginBottom = 20;
    const marginLeft = 30;

    // 通用的缩放功能
    function zoom_chart(svg, x, chartWidth, chartHeight) {
        const extent = [[marginLeft, marginTop], [chartWidth - marginRight, chartHeight - marginTop]];

        svg.call(d3.zoom()
            .scaleExtent([1, 8])
            .translateExtent(extent)
            .extent(extent)
            .on("zoom", zoomed));

        function zoomed(event) {
            const scale = event.transform.k;
            x.range([marginLeft, chartWidth - marginRight].map(d => event.transform.applyX(d)));
            svg.selectAll(".bars rect")
                .attr("x", d => x(d.author))
                .attr("width", x.bandwidth());
            const xAxisGroup = svg.selectAll(".x-axis");
            xAxisGroup.call(d3.axisBottom(x).tickFormat(scale < 3 ? '...' : d => d.split(' ')[1]));
            xAxisGroup.selectAll("text")
                .style("text-anchor", "middle");
        }
    }

    // 单独的图表1绘制函数
    function createChart1(svg, data) {
        const colorScale_chart = d3.scaleLinear()
            .domain([2020, 2024])
            .range(["#ffebf4", "#d32465"]);

        const x = d3.scaleBand()
            .domain(data.map(d => d.year))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.papers)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .selectAll("rect")
            .data(data)
            .join("rect")
            .attr("x", d => x(d.year))
            .attr("y", d => y(d.papers))
            .attr("height", d => y(0) - y(d.papers))
            .attr("width", x.bandwidth())
            .attr("fill", d => colorScale_chart(d.year))
            .on('click', function (e, d) {
                highlightPapersByYear(d.year)
            })
            .on("mouseover", function (event, d) {
                const currentColor = d3.select(this).attr("fill");
                d3.select(this)
                    .attr("fill", d3.rgb(currentColor).darker(1.2));
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(
                    () => {
                        return d.papers
                    })
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function () {
                const originalColor = d3.select(this).attr("fill");
                d3.select(this).attr("fill", d3.rgb(originalColor).brighter(1.2));
                tooltip.transition().duration(500).style("opacity", 0);
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());

        if (data.length > 10) {
            svg.selectAll(".x-axis text")
                .text('...');
        }
    }

    // 单独的图表2绘制函数
    function createChart2(svg, data) {

        const x = d3.scaleBand()
            .domain(data.map(d => d.department))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.4);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.papers)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .selectAll("rect")
            .data(data)
            .join("rect")
            .attr("fill", function (d) {
                if (d.department === 'AI') {
                    return '#6b486b'
                } else if (d.department === 'CMA') {
                    return '#98abc5'
                } else if (d.department === 'DSA') {
                    return '#ff8c00'
                }
            })
            .attr("x", d => x(d.department))
            .attr("y", d => y(d.papers))
            .attr("height", d => y(0) - y(d.papers))
            .attr("width", x.bandwidth())
            .on('click', function (e, d) {
                const sNode = {'name': d.department}
                highlightNeighborhood_2(sNode)
            })
            .on("mouseover", function (event, d) {
                // 获取当前颜色并在鼠标悬浮时加深
                const currentColor = d3.select(this).attr("fill");
                d3.select(this)
                    .attr("fill", d3.rgb(currentColor).darker(1.2));
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`${d.department}<br>${d.papers}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function () {
                // 恢复原来的颜色
                const originalColor = d3.select(this).attr("fill");
                d3.select(this).attr("fill", d3.rgb(originalColor).brighter(1.2));
                tooltip.transition().duration(500).style("opacity", 0);
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());

    }

    // 单独的图表3绘制函数
    function createChart3(svg, data) {

        const keys = ["AI", "CMA", "DSA"];

        const x = d3.scaleBand()
            .domain(data.map(d => d.year))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.AI + d.CMA + d.DSA)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        const color = d3.scaleOrdinal()
            .domain(keys)
            .range(["#6b486b", "#98abc5", "#ff8c00"]);

        const stack = d3.stack()
            .keys(keys)
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);

        const series = stack(data);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .selectAll("g")
            .data(series)
            .join("g")
            .attr("fill", d => color(d.key))
            .selectAll("rect")
            .data(d => d)
            .join("rect")
            .attr("x", d => x(d.data.year))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth())
            .on('click', function (e, d) {

                highlightByDepartmentAndYear(d3.select(this.parentNode).datum().key, String(d.data.year))
            })
            .on("mouseover", function (event, d) {
                const key = d3.select(this.parentNode).datum().key;
                const value = d[1] - d[0];
                d3.select(this)
                    .attr("fill", d3.rgb(color(key)).darker(1.2));
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`${key}<br>${value}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function (event, d) {
                const key = d3.select(this.parentNode).datum().key;
                d3.select(this)
                    .attr("fill", color(key));
                tooltip.transition().duration(500).style("opacity", 0);
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());
    }

    // 单独的图表4绘制函数
    function createChart4(svg, data) {
        const colorScale_auther_chart = d3.scaleLinear()
            .domain([18, 249])
            .range(["#e0f3e5", "#007f5f"]);

        const x = d3.scaleBand()
            .domain(data.map(d => d.author))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.papers)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .selectAll("rect")
            .data(data)
            .join("rect")
            .attr("fill", d => colorScale_auther_chart(d.papers))
            .attr("x", d => x(d.author))
            .attr("y", d => y(d.papers))
            .attr("height", d => y(0) - y(d.papers))
            .attr("width", x.bandwidth())
            .on('click', function(e, d) {
                const sNode = {'name': d.author}
                highlightNeighborhood(sNode)
            })
            .on("mouseover", function (e, d) {
                // 获取当前颜色并在鼠标悬浮时加深
                const currentColor = d3.select(this).attr("fill");
                d3.select(this)
                    .attr("fill", d3.rgb(currentColor).darker(1.2));
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(
                    () => {
                        return d.author + '<br>' + d.papers
                    })
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function () {
                // 恢复原来的颜色
                const originalColor = d3.select(this).attr("fill");
                d3.select(this).attr("fill", d3.rgb(originalColor).brighter(1.2));
                tooltip.transition().duration(500).style("opacity", 0);
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0).tickFormat(d => data.length > 20 ? '...' : d.split(' ')[1]))
            .selectAll("text")
            .style("text-anchor", "middle")
            .attr("font-size", "10px");

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());

        if (data.length > 10) {
            svg.selectAll(".x-axis text")
                .text('...');
        }

        if (data.length > 10) {
            zoom_chart(svg, x, chartWidth, chartHeight);
        }
    }


</script>

<script>
    $(document).ready(function () {
        // 分别调用每个图表的绘制函数
        {#d3.select("#chart1").call(createChart1);#}
        {#d3.select("#chart2").call(createChart2);#}
        {#d3.select("#chart3").call(createChart3);#}
        {#d3.select("#chart4").call(createChart4);#}
        loadDataForChart()
    });

    function loadDataForChart() {
        $.ajax({
            url: 'http://127.0.0.1:8000/data_neo4j/forChart',
            type: 'get',
            data: {},
            success: function (res) {
                let request = JSON.parse(res)
                createChart1(d3.select("#chart1"), request['chart1'])
                createChart2(d3.select("#chart2"), request['chart2'])
                createChart3(d3.select("#chart3"), request['chart3'])
                createChart4(d3.select("#chart4"), request['chart4'])
            }
        });
    }
</script>

</body>
</html>
