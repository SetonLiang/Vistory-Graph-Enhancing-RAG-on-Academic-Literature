<!DOCTYPE html>
{% load static %}
{% load my_filter %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chart</title>
    <link rel="stylesheet" href="{% static 'css/for_chart.css' %}">
    <style>
    </style>
</head>
<body>

<!-- Create a div where the graph will take place -->
<div id="dataVis" class="chart_container">
    <!-- Add buttons with a container -->
</div>

<script>
    const x0Name = ['a', 'b', 'c', 'd', 'e'];
    const x1Name = [2000, 2001, 2002, 2003];
    let data = [];

    function generateInitialData() {
        data = [];
        x0Name.forEach(_x0n => {
            const _data = [];
            x1Name.forEach(_x1n => {
                _data.push(Math.floor(Math.random() * 100));
            });
            data.push(_data);
        });
    }

    function createChart() {
        generateInitialData();
        Init_width = d3.select('.chart_container').node().getBoundingClientRect().width;
        Init_height = d3.select('.chart_container').node().getBoundingClientRect().height;

        // set the dimensions and margins of the graph
        margin = {top: 10, right: 30, bottom: 50, left: 40};
        width_chart = Init_width - margin.left - margin.right;
        height_chart = Init_height - margin.top - margin.bottom;

        // append the svg object to the body of the page
        svg_chart = d3.select("#dataVis")
            .append("svg")
            .attr("width", width_chart + margin.left + margin.right)
            .attr("height", height_chart + margin.top + margin.bottom)
            .style('display', 'block')
            .style('background-color', 'white');

        g_chart = svg_chart.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        x0 = d3.scaleBand().domain(x0Name).range([0, width_chart]).paddingInner(0.1);
        x1 = d3.scaleBand().domain(x1Name).rangeRound([0, x0.bandwidth()]).padding(0.05);
        y = d3.scaleLinear().domain([0, 100]).range([height_chart, 0]);
        z = d3.scaleOrdinal().range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b"]);

        g_chart.append('g').attr('transform', `translate(0,${height_chart})`).call(d3.axisBottom(x0));
        g_chart.append('g').attr('transform', `translate(0,0)`).call(d3.axisLeft(y));

        // Draw initial bars
        drawBars(data, "original");
        drawLegend();
    }

    function drawBars(data, className) {
        // Draw bars with a specific class name
        g_chart.selectAll(`g_chart.bars.${className}`)
            .data(data)
            .join('g')
            .attr('class', `bars ${className}`)
            .attr('transform', (d, i) => `translate(${x0(x0Name[i])},0)`)
            .selectAll('rect')
            .data(d => d)
            .join('rect')
            .attr('x', (d, i) => x1(x1Name[i]))
            .attr('y', d => y(d))
            .attr('width', x1.bandwidth())
            .attr('height', d => height_chart - y(d))
            .attr('fill', (d, i) => {
                if (className === "new" || className === "original") {
                    return z(i); // Color for new data
                } else {
                    return d3.rgb(z(i)).brighter(1); // Lighter color for old data
                }
            });
    }

    function drawLegend() {
        // Draw legend
        const legend = g_chart.selectAll('g_chart.legend')
            .data(x1Name)
            .join('g')
            .attr('class', 'legend')
            .attr('transform', (d, i) => `translate(0,${i * 20})`);

        legend.append('rect')
            .attr('x', width_chart - 19)
            .attr('width', 19)
            .attr('height', 19)
            .attr('fill', (d, i) => z(i));

        legend.append('text')
            .attr('x', width_chart - 60)
            .attr('y', 9.5)
            .attr('dy', '0.32em')
            .text(d => d);
    }

    function updateData() {
        // Generate new data
        const newData = [];
        x0Name.forEach((_, i) => {
            const _data = [];
            x1Name.forEach((_, j) => {
                // Ensure new data is less than old data
                _data.push(Math.floor(Math.random() * Math.min(100, data[i][j])));
            });
            newData.push(_data);
        });

        // Update the data variable
        data = newData;

        // Make old data bars lighter
        g_chart.selectAll('g_chart.bars.original rect')
            .transition().duration(500)
            .attr('fill', '#c6c6c6');

        // Draw new bars on top
        drawBars(newData, "new");
    }

</script>

<script>
    $(document).ready(function () {
        createChart();
        LoadDepartmentData()
    });


    function LoadDepartmentData() {
        $.ajax({
            url: 'http://127.0.0.1:8000/data_neo4j/departments',
            type: 'get',
            data: {},
            success: function (res) {
                department_data = JSON.parse(res);
            }
        });
    }

    function LoadYearData_csv_dataset() {
        $.ajax({
            url: 'http://127.0.0.1:8000/data/years',
            type: 'get',
            data: {},
            success: function (res) {
                year_data = JSON.parse(res);
                update(year_data, 'year');
            }
        });
    }

    function LoadAuthorsData_csv_dataset() {
        $.ajax({
            url: 'http://127.0.0.1:8000/data/authors',
            type: 'get',
            data: {},
            success: function (res) {
                author_data = JSON.parse(res);
            }
        });
    }
</script>
</body>
</html>
