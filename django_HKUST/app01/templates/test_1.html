<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizontal Bar Charts in Container</title>
    <style>
        .chart_container {
            width: 877px;
            height: 220px;
            display: flex;
            flex-wrap: nowrap; /* Prevent wrapping */
            overflow-x: auto;
        }

        .chart {
            flex: 1; /* Make each chart occupy 25% of the container's width */
            height: 100%; /* Full height of the container */
        }

        svg {
            width: 100%;
            height: 100%;
            font-size: 12px; /* Adjust font size */
        }

        .x-axis text,
        .y-axis text {
            font-size: 10px; /* Font size for axis labels */
        }
    </style>
</head>
<body>

<script src="../static/js/jquery-3.7.1.js"></script>
<script src="../static/plugins/d3/d3.v7.js"></script>

<div id="dataVis" class="chart_container">
    <div class="chart">
        <svg id="chart1"></svg>
    </div>
    <div class="chart">
        <svg id="chart2"></svg>
    </div>
    <div class="chart">
        <svg id="chart3"></svg>
    </div>
    <div class="chart">
        <svg id="chart4"></svg>
    </div>
</div>

<script>
    const containerWidth = 877;
    const containerHeight = 220;
    const chartWidth = containerWidth / 4; // 每个图表宽度占容器的25%
    const chartHeight = containerHeight;
    const marginTop = 30;
    const marginRight = 10;
    const marginBottom = 20;
    const marginLeft = 30;

    // 通用的缩放功能
    function zoom(svg, x, chartWidth, chartHeight) {
        const extent = [[marginLeft, marginTop], [chartWidth - marginRight, chartHeight - marginTop]];

        svg.call(d3.zoom()
            .scaleExtent([1, 8])
            .translateExtent(extent)
            .extent(extent)
            .on("zoom", zoomed));

        function zoomed(event) {
            const scale = event.transform.k;
            x.range([marginLeft, chartWidth - marginRight].map(d => event.transform.applyX(d)));
            svg.selectAll(".bars rect")
                .attr("x", d => x(d.author))
                .attr("width", x.bandwidth());
            const xAxisGroup = svg.selectAll(".x-axis");
            xAxisGroup.call(d3.axisBottom(x).tickFormat(scale < 4 ? '...' : d => d));
            xAxisGroup.selectAll("text")
                .style("text-anchor", "middle");
        }
    }

    // 单独的图表1绘制函数
    function createChart1(svg) {
        const data = [
            {year: 2015, papers: 1500},
            {year: 2016, papers: 2500},
            {year: 2017, papers: 500},
            {year: 2018, papers: 3000},
            {year: 2019, papers: 2000}
        ];

        const x = d3.scaleBand()
            .domain(data.map(d => d.year))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.papers)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .selectAll("rect")
            .data(data)
            .join("rect")
            .attr("x", d => x(d.year))
            .attr("y", d => y(d.papers))
            .attr("height", d => y(0) - y(d.papers))
            .attr("width", x.bandwidth())
            .attr("fill", "steelblue")
            .on("mouseover", function () {
                d3.select(this).attr("fill", "orange");
            })
            .on("mouseout", function () {
                d3.select(this).attr("fill", "steelblue");
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());

        if (data.length > 10) {
            svg.selectAll(".x-axis text")
                .text('...');
        }
    }

    // 单独的图表2绘制函数
    function createChart2(svg) {
        const data = [
            {year: 2015, departmentA: 400, departmentB: 600, departmentC: 200},
            {year: 2016, departmentA: 300, departmentB: 700, departmentC: 400},
            {year: 2017, departmentA: 500, departmentB: 800, departmentC: 300},
            {year: 2018, departmentA: 600, departmentB: 900, departmentC: 500},
            {year: 2019, departmentA: 700, departmentB: 1000, departmentC: 400}
        ];

        const keys = ["departmentA", "departmentB", "departmentC"];

        const x = d3.scaleBand()
            .domain(data.map(d => d.year))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.departmentA + d.departmentB + d.departmentC)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        const color = d3.scaleOrdinal()
            .domain(keys)
            .range(["#6b486b", "#98abc5", "#ff8c00"]);

        const stack = d3.stack()
            .keys(keys)
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);

        const series = stack(data);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .selectAll("g")
            .data(series)
            .join("g")
            .attr("fill", d => color(d.key))
            .selectAll("rect")
            .data(d => d)
            .join("rect")
            .attr("x", d => x(d.data.year))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth())
            .on("mouseover", function (event, d) {
                const key = d3.select(this.parentNode).datum().key;
                d3.select(this)
                    .attr("fill", d3.rgb(color(key)).darker(1.2));
            })
            .on("mouseout", function (event, d) {
                const key = d3.select(this.parentNode).datum().key;
                d3.select(this)
                    .attr("fill", color(key));
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());

        // Optionally, add a legend to indicate which color corresponds to which department
        const legend = svg.append("g")
            .attr("transform", `translate(${chartWidth - marginRight - 100}, ${marginTop})`);

        legend.selectAll("rect")
            .data(keys)
            .enter().append("rect")
            .attr("x", 0)
            .attr("y", (d, i) => i * 20)
            .attr("width", 12)
            .attr("height", 12)
            .attr("fill", color);

        legend.selectAll("text")
            .data(keys)
            .enter().append("text")
            .attr("x", 20)
            .attr("y", (d, i) => i * 20 + 10)
            .text(d => d)
            .attr("font-size", "12px")
            .attr("alignment-baseline", "middle");
    }

    // 单独的图表3绘制函数
    function createChart3(svg) {
        const data = [
            {department: "CMA", papers: 1200},
            {department: "AI", papers: 1500},
            {department: "DSA", papers: 800}
        ];

        const x = d3.scaleBand()
            .domain(data.map(d => d.department))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.2);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.papers)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .attr("fill", "steelblue")
            .selectAll("rect")
            .data(data)
            .join("rect")
            .attr("x", d => x(d.department))
            .attr("y", d => y(d.papers))
            .attr("height", d => y(0) - y(d.papers))
            .attr("width", x.bandwidth())
            .on("mouseover", function () {
                d3.select(this).attr("fill", "orange");
            })
            .on("mouseout", function () {
                d3.select(this).attr("fill", "steelblue");
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0));

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());
    }

    // 单独的图表4绘制函数
    function createChart4(svg) {
        const data = Array.from({length: 25}, (_, i) => ({
            author: `Author ${String.fromCharCode(65 + i)}`,
            papers: Math.floor(Math.random() * 100) + 1
        }));

        const x = d3.scaleBand()
            .domain(data.map(d => d.author))
            .range([marginLeft, chartWidth - marginRight])
            .padding(0.2);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.papers)]).nice()
            .range([chartHeight - marginBottom, marginTop]);

        svg.attr("viewBox", [0, 0, chartWidth, chartHeight])
            .attr("style", "width: 100%; height: 100%;");

        svg.append("g")
            .attr("class", "bars")
            .attr("fill", "steelblue")
            .selectAll("rect")
            .data(data)
            .join("rect")
            .attr("x", d => x(d.author))
            .attr("y", d => y(d.papers))
            .attr("height", d => y(0) - y(d.papers))
            .attr("width", x.bandwidth())
            .on("mouseover", function () {
                d3.select(this).attr("fill", "orange");
            })
            .on("mouseout", function () {
                d3.select(this).attr("fill", "steelblue");
            });

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", `translate(0,${chartHeight - marginBottom})`)
            .call(d3.axisBottom(x).tickSizeOuter(0).tickFormat(d => data.length > 20 ? '...' : d))
            .selectAll("text")
            .style("text-anchor", "middle")
            .attr("font-size", "10px");

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", `translate(${marginLeft},0)`)
            .call(d3.axisLeft(y).tickFormat(d3.format(".2s")))
            .call(g => g.select(".domain").remove());

        if (data.length > 10) {
            svg.selectAll(".x-axis text")
                .text('...');
        }

        if (data.length > 10) {
            zoom(svg, x, chartWidth, chartHeight);
        }
    }

    // 分别调用每个图表的绘制函数
    d3.select("#chart1").call(createChart1);
    d3.select("#chart2").call(createChart2);
    d3.select("#chart3").call(createChart3);
    d3.select("#chart4").call(createChart4);
</script>
</body>
</html>